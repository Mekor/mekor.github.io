
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  åŸç†æ¢ç©¶ - æå°äº‰
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="è®°å½•å¼€å‘ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="æå°äº‰" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//é“¾æ¥æ–°å¼€çª—å£
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">æå°äº‰</a></h1>
  
    <h2>è®°å½•å¼€å‘ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.citynight.cn/Blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="self" href="index.html">Home</a></li>

  <li id=""><a target="_self" href="archives.html">Archives</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15653483390225.html">å›¾åƒæ˜¾ç¤ºåŸç†</a></h1>
			<p class="meta"><time datetime="2019-08-09T18:58:59+08:00" 
			pubdate data-updated="true">2019/8/9</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p><img src="media/15653483390225/WX20190809-201518@2x.png" alt="WX20190809-201518@2x"/></p>

<p><img src="media/15653483390225/15656069984426.jpg" alt="" style="width:979px;"/><br/>
<img src="media/15653483390225/15656070181148.jpg" alt="" style="width:677px;"/></p>

<p><img src="media/15653483390225/15666279613682.jpg" alt="" style="width:755px;"/></p>

<p>ç³»ç»Ÿç»˜åˆ¶æµç¨‹<br/>
<img src="media/15653483390225/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20-4-.jpg" alt="æœªå‘½åæ–‡ä»¶ -4-"/></p>

<p>å¼‚æ­¥ç»˜åˆ¶æµç¨‹(æ—¶åºå›¾)<br/>
<img src="media/15653483390225/Jietu20190824-150035.jpg" alt="Jietu20190824-150035"/></p>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15653376209289.html">äº‹ä»¶ä¼ é€’</a></h1>
			<p class="meta"><time datetime="2019-08-09T16:00:20+08:00" 
			pubdate data-updated="true">2019/8/9</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>æ•´ä½“çš„äº‹ä»¶ä¼ é€’æµç¨‹<br/>
<img src="media/15653376209289/15653376299374.jpg" alt="" style="width:687px;"/></p>

<p>è¯¦ç»†çš„<code>hitTset:withEvent:</code>ç³»ç»Ÿå®ç°<br/>
<img src="media/15653376209289/15653413218867.jpg" alt=""/></p>

<p>æ³¨ï¼šå…ˆåˆ¤æ–­è§†å›¾æ˜¯å¦éšè—å¯äº¤äº’ï¼Œä¸æ»¡è¶³æ¡ä»¶è¿”å›nil, å¦‚æœä¸åœ¨ç‚¹å‡»èŒƒå›´å†…å°±è¿”å›nil,åœ¨ç‚¹å‡»èŒƒå›´å†…å°±éå†å­è§†å›¾ã€‚éå†å­è§†å›¾çš„æ—¶å€™å¦‚æœéƒ½æ²¡æœ‰å­è§†å›¾å“åº”äº‹ä»¶ï¼Œé‚£ä¹ˆå°±æŠŠè§†å›¾æœ¬èº«<code>v</code>è¿”å›ï¼Œå¦‚æœæœ‰å­è§†å›¾å“åº”å°±è¿”å›å½“å‰å­è§†å›¾ã€‚</p>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14733118707964.html">è½¬å‘æœºåˆ¶</a></h1>
			<p class="meta"><time datetime="2016-09-08T13:17:50+08:00" 
			pubdate data-updated="true">2016/9/8</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<blockquote>
<p>åŸºæœ¬é€»è¾‘æ¥æºè‡ªå®˜æ–¹æ–‡æ¡£ <a href="https://developer.apple.com/library/prerelease/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html">Message Forwarding</a> ,è¿™é‡Œåªåšç›¸å…³ä¾‹å­çš„è§£æ.</p>
</blockquote>

<p>å½“ä¸€ä¸ªå¯¹è±¡èƒ½æ¥æ”¶ä¸€ä¸ªæ¶ˆæ¯æ—¶ï¼Œå°±ä¼šèµ°æ­£å¸¸çš„æ–¹æ³•è°ƒç”¨æµç¨‹ã€‚ä½†å¦‚æœä¸€ä¸ªå¯¹è±¡æ— æ³•æ¥æ”¶æŒ‡å®šæ¶ˆæ¯æ—¶ï¼Œåˆä¼šå‘ç”Ÿä»€ä¹ˆäº‹å‘¢ï¼Ÿé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ä»¥ [object message]çš„æ–¹å¼è°ƒç”¨æ–¹æ³•ï¼Œå¦‚æœobjectæ— æ³•å“åº”messageæ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ä½†å¦‚æœæ˜¯ä»¥performâ€¦çš„å½¢å¼æ¥è°ƒç”¨ï¼Œåˆ™éœ€è¦ç­‰åˆ°è¿ è¡Œæ—¶æ‰èƒ½ç¡®å®šobjectæ˜¯å¦èƒ½æ¥æ”¶messageæ¶ˆæ¯ã€‚å¦‚æœä¸èƒ½ï¼Œåˆ™ç¨‹åºå´©æºƒã€‚<br/>
é€šå¸¸ï¼Œå½“æˆ‘ä»¬ä¸èƒ½ç¡®å®šä¸€ä¸ªå¯¹è±¡æ˜¯å¦èƒ½æ¥æ”¶æŸä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆè°ƒç”¨<code>respondsToSelector:</code>æ¥åˆ¤æ–­ä¸€ä¸‹ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>

<pre><code class="language-text">if ([self respondsToSelector:@selector(method)]) {
    [self performSelector:@selector(method)];
}
</code></pre>

<p>å½“ä¸ä½¿ç”¨<code>respondsToSelector:</code>åˆ¤æ–­æ—¶,å°±ä¼šå¯åŠ¨&#39;æ¶ˆæ¯è½¬å‘(message forwarding)&#39;æœºåˆ¶,é€šè¿‡è¿™ä¸€æœºåˆ¶æˆ‘ä»¬å¯ä»¥å‘Šè¯‰å¯¹è±¡å¦‚ä½•å¤„ç†æœªçŸ¥çš„æ¶ˆæ¯.å¦‚æœä¸åšä»»ä½•å¤„ç†ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¼‚å¸¸ä¿¡æ¯å¦‚ä¸‹:</p>

<pre><code class="language-text">2016-09-08 13:26:53.094 selfsuper[65176:7154658] -[Student eat]: unrecognized selector sent to instance 0x7ff1b9f9f690
2016-09-08 13:26:53.103 selfsuper[65176:7154658] *** Terminating app due to uncaught exception &#39;NSInvalidArgumentException&#39;, reason: &#39;-[Student eat]: unrecognized selector sent to instance 0x7ff1b9f9f690&#39;
</code></pre>

<p>è¿™æ®µå¼‚å¸¸ä¿¡æ¯å®é™…ä¸Šæ˜¯ç”±NSObjectçš„<code>doesNotRecognizeSelector</code>æ–¹æ³•æŠ›å‡ºçš„ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸€äº›æªæ–½ï¼Œè®©æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œç‰¹å®šçš„é€»è¾‘ï¼Œè€Œé¿å…ç¨‹åºçš„å´©æºƒã€‚</p>

<p>æ¶ˆæ¯è½¬å‘æœºåˆ¶åŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p>

<ol>
<li><p>åŠ¨æ€æ–¹æ³•è§£æ</p></li>
<li><p>å¤‡ç”¨æ¥æ”¶è€…</p></li>
<li><p>å®Œæ•´è½¬å‘</p></li>
</ol>

<h2 id="toc_0">åŠ¨æ€æ–¹æ³•è§£æ</h2>

<p>å¯¹è±¡åœ¨æ¥æ”¶åˆ°æœªçŸ¥çš„æ¶ˆæ¯æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨æ‰€å±ç±»çš„ç±»æ–¹æ³•+resolveInstanceMethod:(å®ä¾‹æ–¹æ³•)æˆ– è€…+resolveClassMethod:(ç±»æ–¹æ³•)ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æœ‰æœºä¼šä¸ºè¯¥æœªçŸ¥æ¶ˆæ¯æ–°å¢ä¸€ä¸ªâ€å¤„ç†æ–¹æ³•â€â€œã€‚ä¸è¿‡ä½¿ç”¨è¯¥æ–¹æ³•çš„å‰ææ˜¯æˆ‘ä»¬å·²ç» å®ç°äº†è¯¥â€å¤„ç†æ–¹æ³•â€ï¼Œåªéœ€è¦åœ¨è¿è¡Œæ—¶é€šè¿‡class_addMethodå‡½æ•°åŠ¨æ€æ·»åŠ åˆ°ç±»é‡Œé¢å°±å¯ä»¥äº†ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>

<pre><code class="language-text">// void(*)()
// é»˜è®¤æ–¹æ³•éƒ½æœ‰ä¸¤ä¸ªéšå¼å‚æ•°ï¼Œ
void eat(id self,SEL sel)
{
    NSLog(@&quot;%@ %@&quot;,self,NSStringFromSelector(sel));
}

// å½“ä¸€ä¸ªå¯¹è±¡è°ƒç”¨æœªå®ç°çš„æ–¹æ³•ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•å¤„ç†,å¹¶ä¸”ä¼šæŠŠå¯¹åº”çš„æ–¹æ³•åˆ—è¡¨ä¼ è¿‡æ¥.
// åˆšå¥½å¯ä»¥ç”¨æ¥åˆ¤æ–­ï¼Œæœªå®ç°çš„æ–¹æ³•æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦åŠ¨æ€æ·»åŠ çš„æ–¹æ³•
+ (BOOL)resolveInstanceMethod:(SEL)sel
{
    if (sel == NSSelectorFromString(@&quot;eat&quot;)) {
        // åŠ¨æ€æ·»åŠ eatæ–¹æ³•
        
        // ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•
        // ç¬¬äºŒä¸ªå‚æ•°ï¼šæ·»åŠ æ–¹æ³•çš„æ–¹æ³•ç¼–å·
        // ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ·»åŠ æ–¹æ³•çš„å‡½æ•°å®ç°ï¼ˆå‡½æ•°åœ°å€ï¼‰
        // ç¬¬å››ä¸ªå‚æ•°ï¼šå‡½æ•°çš„ç±»å‹ï¼Œ(è¿”å›å€¼+å‚æ•°ç±»å‹) v:void @:å¯¹è±¡-&gt;self :è¡¨ç¤ºSEL-&gt;_cmd
        class_addMethod(self, NSSelectorFromString(@&quot;eat&quot;), (IMP)eat, &quot;v@:&quot;);
        
    }
    
    return [super resolveInstanceMethod:sel];
}

</code></pre>

<p>ä¸è¿‡è¿™ç§æ–¹æ¡ˆæ›´å¤šçš„æ˜¯ä¸ºäº†å®ç°@dynamicå±æ€§ã€‚</p>

<h2 id="toc_1">å¤‡ç”¨æ¥æ”¶è€…</h2>

<p>å¦‚æœåœ¨ä¸Šä¸€æ­¥æ— æ³•å¤„ç†æ¶ˆæ¯ï¼Œåˆ™Runtimeä¼šç»§ç»­è°ƒä»¥ä¸‹æ–¹æ³•ï¼š</p>

<pre><code class="language-text">- (id)forwardingTargetForSelector:(SEL)aSelector
</code></pre>

<p>å¦‚æœä¸€ä¸ªå¯¹è±¡å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶è¿”å›ä¸€ä¸ªénilçš„ç»“æœï¼Œåˆ™è¿™ä¸ªå¯¹è±¡ä¼šä½œä¸ºæ¶ˆæ¯çš„æ–°æ¥æ”¶è€…ï¼Œä¸”æ¶ˆæ¯ä¼šè¢«åˆ†å‘åˆ°è¿™ä¸ªå¯¹è±¡ã€‚å½“ç„¶è¿™ä¸ªå¯¹è±¡ä¸èƒ½æ˜¯selfè‡ªèº«ï¼Œå¦åˆ™å°±æ˜¯å‡ºç°æ— é™å¾ªç¯ã€‚å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šç›¸åº”çš„å¯¹è±¡æ¥å¤„ç†aSelectorï¼Œåˆ™åº”è¯¥è°ƒç”¨çˆ¶ç±»çš„å®ç°æ¥è¿”å›ç»“æœã€‚</p>

<p>ä½¿ç”¨è¿™ä¸ªæ–¹æ³•é€šå¸¸æ˜¯åœ¨å¯¹è±¡å†…éƒ¨ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ç³»åˆ—å…¶å®ƒå¯¹è±¡èƒ½å¤„ç†è¯¥æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä¾¿å¯å€Ÿè¿™äº›å¯¹è±¡æ¥å¤„ç†æ¶ˆæ¯å¹¶è¿”å›ï¼Œè¿™æ ·åœ¨å¯¹è±¡å¤–éƒ¨çœ‹æ¥ï¼Œè¿˜æ˜¯ç”±è¯¥å¯¹è±¡äº²è‡ªå¤„ç†äº†è¿™ä¸€æ¶ˆæ¯ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>

<pre><code class="language-text">/**
 * æµ‹è¯•æ¶ˆæ¯è½¬å‘
 */
-(id)forwardingTargetForSelector:(SEL)aSelector {
    NSLog(@&quot;æ¶ˆæ¯è½¬å‘&quot;);
    NSString *selectorString = NSStringFromSelector(aSelector);
    if ([selectorString isEqualToString:@&quot;eat2&quot;]){
        // å°†æ¶ˆæ¯è½¬ç»™ RuntimeHelper å¯¹è±¡,è®©ä»–æ¥å¤„ç†
        return [RuntimeHelper new];
    }
    return [super forwardingTargetForSelector:aSelector];
}

</code></pre>

<p>è¿™ä¸€æ­¥åˆé€‚äºæˆ‘ä»¬åªæƒ³å°†æ¶ˆæ¯è½¬å‘åˆ°å¦ä¸€ä¸ªèƒ½å¤„ç†è¯¥æ¶ˆæ¯çš„å¯¹è±¡ä¸Šã€‚ä½†è¿™ä¸€æ­¥æ— æ³•å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¦‚æ“ä½œæ¶ˆæ¯çš„å‚æ•°å’Œè¿”å›å€¼ã€‚å¦‚æœéœ€è¦ä¿®æ”¹å‚æ•°å’Œè¿”å›å€¼,å¯ä»¥ä½¿ç”¨å®Œæ•´æ¶ˆæ¯è½¬å‘.</p>

<h2 id="toc_2">å®Œæ•´æ¶ˆæ¯è½¬å‘</h2>

<p>å¦‚æœåœ¨ä¸Šä¸€æ­¥è¿˜ä¸èƒ½å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™å”¯ä¸€èƒ½åšçš„å°±æ˜¯å¯ç”¨å®Œæ•´çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶äº†ã€‚æ­¤æ—¶ä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•:</p>

<pre><code class="language-text">-Â (void)forwardInvocation:(NSInvocationÂ *)anInvocation
</code></pre>

<p>å®Œæ•´ä»£ç :</p>

<pre><code class="language-text">/**
 *  å®Œæ•´çš„æ¶ˆæ¯è½¬å‘
 */

/* å¿…é¡»é‡å†™ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector
 * æ¶ˆæ¯è½¬å‘æœºåˆ¶ä½¿ç”¨ä»è¿™ä¸ªæ–¹æ³•ä¸­è·å–çš„ä¿¡æ¯æ¥åˆ›å»ºNSInvocationå¯¹è±¡ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œä¸ºç»™å®šçš„selectoræä¾›ä¸€ä¸ªåˆé€‚çš„æ–¹æ³•ç­¾åã€‚
 */
- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector {
    NSMethodSignature *signature = [super methodSignatureForSelector:aSelector];
    
    if (!signature) {
        if ([RuntimeHelper instancesRespondToSelector:aSelector]) {
            signature = [RuntimeHelper instanceMethodSignatureForSelector:aSelector];
        }
    }
    
    return signature;
}

-(void)forwardInvocation:(NSInvocation *)anInvocation {
    if ([RuntimeHelper instanceMethodSignatureForSelector:anInvocation.selector]) {
        [anInvocation invokeWithTarget:[RuntimeHelper new]];
    }
}
</code></pre>

<p>å…³äº NSInvocation å¯ä»¥å‚è§<a href="https://github.com/Mekor/MKExtension">MKExtension</a>ä¸­<code>NSObject+SEL</code>,é‡Œé¢æœ‰å…³äº NSInvocation çš„åº”ç”¨.</p>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14731740142157.html">RunLoop</a></h1>
			<p class="meta"><time datetime="2016-09-06T23:00:14+08:00" 
			pubdate data-updated="true">2016/9/6</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<h2 id="toc_0">1. ä»€ä¹ˆæ˜¯runloop</h2>

<ul>
<li>Run loops æ˜¯çº¿ç¨‹ç›¸å…³çš„çš„åŸºç¡€æ¡†æ¶çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ª run loop å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç† çš„å¾ªç¯,ç”¨æ¥ä¸åœçš„è°ƒåº¦å·¥ä½œä»¥åŠå¤„ç†è¾“å…¥äº‹ä»¶ã€‚ä½¿ç”¨ run loop çš„ç›®çš„æ˜¯è®©ä½ çš„çº¿ç¨‹åœ¨æœ‰å·¥ä½œçš„æ—¶å€™å¿™äºå·¥ä½œ,è€Œæ²¡å·¥ä½œçš„æ—¶å€™å¤„äºä¼‘çœ çŠ¶æ€ã€‚</li>
<li>runloopå°±æ˜¯è¿è¡Œå¾ªç¯(å†…éƒ¨do-while),å®ƒçš„åŸºæœ¬ä½œç”¨å°±æ˜¯è®©ç¨‹åºæŒç»­è¿è¡Œ,å¤„ç†Appä¸­çš„å„ç§äº‹ä»¶(è§¦æ‘¸,å®šæ—¶å™¨,Selector).</li>
<li>mainå‡½æ•°ä¸­UIApplicationMainå†…éƒ¨å°±å¯åŠ¨äº†ä¸€ä¸ªrunloop,è¿™æ ·UIApplicationMainå°±ä¼šä¸€ç›´æ²¡æœ‰è¿”å›å€¼,ä¿æŒäº†ç¨‹åºçš„æŒç»­è¿è¡Œ.è¿™ä¸ªé»˜è®¤çš„runloopæ˜¯è·Ÿä¸»çº¿ç¨‹ç›¸å…³è”çš„.</li>
<li>runloop åªèƒ½é€‰æ‹©ä¸€ä¸ªæ¨¡å¼(Mode)å¯åŠ¨,å¦‚æœæƒ³åˆ‡æ¢å…¶ä»–æ¨¡å¼åªèƒ½é€€å‡ºå½“å‰å¾ªç¯å†åˆ‡æ¢å…¶ä»–æ¨¡å¼.å¦‚æœå½“å‰æ¨¡å¼ä¸­æ²¡æœ‰ä»»ä½•Source,timer,observerå°±ä¼šé€€å‡ºrunloop</li>
</ul>

<h2 id="toc_1">2. RunLoopä¸çº¿ç¨‹</h2>

<p>æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopå¯¹è±¡,ä¸»çº¿ç¨‹çš„RunLoopå¯åŠ¨çš„æ—¶å€™å·²ç»é»˜è®¤åˆ›å»ºå¥½äº†,å…¶ä»–çº¿ç¨‹çš„RunLoopéœ€è¦ä¸»åŠ¨åˆ›å»º(RunLoopåœ¨ç¬¬ä¸€æ¬¡è·å–çš„æ—¶å€™åˆ›å»º,åœ¨çº¿ç¨‹ç»“æŸçš„æ—¶å€™é”€æ¯)</p>

<h2 id="toc_2">3. RunLoopå¯¹è±¡</h2>

<h4 id="toc_3">iOSä¸­æœ‰2å¥—APIæ¥è®¿é—®å’Œä½¿ç”¨runloop</h4>

<ul>
<li> Foundation -&gt; NSRunLoop</li>
<li> Core Foundation -&gt; CFRunLoopRef</li>
</ul>

<p>NSRunLoopå’ŒCFRunLoopReféƒ½æ˜¯runloopå¯¹è±¡.NSRunLoopæ˜¯åŸºäºCFRunLoopRefçš„ä¸€å±‚OCå°è£…</p>

<h4 id="toc_4">è·å¾—RunLoopå¯¹è±¡</h4>

<ul>
<li><p>Foundation </p>
<pre><code class="language-objectivec">[NSRunLoop currentRunLoop]; // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡
[NSRunLoop mainRunLoop]; // è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡
</code></pre></li>
<li><p>Core Foundation </p>
<pre><code class="language-objectivec">CFRunLoopGetCurrent(): // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡
CFRunLoopGetMain(): //è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡
</code></pre></li>
</ul>

<h2 id="toc_5">4. RunLoopç›¸å…³ç±»</h2>

<h3 id="toc_6">Core Foundationä¸­å…³äºRunLoopçš„5ä¸ªç±»</h3>

<ul>
<li>CFRunLoopRef</li>
<li>CFRunLoopModeRef</li>
<li>CFRunLoopSourceRef</li>
<li>CFRunLoopTimerRef</li>
<li>CFRunLoopObserverRef</li>
</ul>

<p>ç½‘ä¸Šå…¶ä»–äººåšå®¢æ€»ç»“(å›¾ä¸€):<br/>
<img src="media/14731740142157/14731758243846.jpg" alt=""/></p>

<h3 id="toc_7">CFRunLoopModeRef(Run Loop æ¨¡å¼)</h3>

<p><strong>CFRunLoopModeRefä»£è¡¨RunLoopçš„è¿è¡Œæ¨¡å¼</strong>  ä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªMode,æ¯ä¸ªModeåˆåŒ…å«è‹¥å¹²ä¸ªSource/Timer/Observer. æ¯æ¬¡RunLoopå¯åŠ¨æ—¶,åªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªMode,è¿™ä¸ªModeè¢«ç§°ä¹‹ä¸ºCurrentMode. å¦‚æœéœ€è¦åˆ‡æ¢Mode,åªèƒ½é€€å‡ºLoop,å†é‡æ–°æŒ‡å®šä¸€ä¸ªModeè¿›å…¥. è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„Source/Timer/Observer,è®©ä»–ä»¬äº’ä¸å½±å“.</p>

<p>Run loop æ¨¡å¼æ˜¯æ‰€æœ‰è¦ç›‘è§†çš„è¾“å…¥æºå’Œå®šæ—¶æºä»¥åŠè¦é€šçŸ¥çš„ run loop æ³¨å†Œè§‚å¯Ÿè€…çš„é›†åˆã€‚æ¯æ¬¡è¿è¡Œä½ çš„ run loop,ä½ éƒ½è¦æŒ‡å®š(æ— è®ºæ˜¾ç¤ºè¿˜æ˜¯éšå¼)å…¶è¿è¡Œä¸ªæ¨¡å¼ã€‚åœ¨ run loop è¿è¡Œè¿‡ç¨‹ä¸­,åªæœ‰å’Œæ¨¡å¼ç›¸å…³çš„æºæ‰ä¼šè¢«ç›‘è§†å¹¶å…è®¸ä»–ä»¬ä¼ é€’äº‹ä»¶æ¶ˆæ¯ã€‚(ç±»ä¼¼çš„,åªæœ‰å’Œæ¨¡å¼ç›¸å…³çš„è§‚å¯Ÿè€…ä¼šé€šçŸ¥ run loop çš„è¿›ç¨‹)ã€‚å’Œå…¶ä»–æ¨¡å¼å…³è”çš„æºåªæœ‰åœ¨ run loop è¿è¡Œåœ¨å…¶æ¨¡å¼ä¸‹æ‰ä¼šè¿è¡Œ,å¦åˆ™å¤„äºæš‚åœçŠ¶æ€ã€‚</p>

<h3 id="toc_8">CFRunLoopModeRef</h3>

<p><strong>ç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode:</strong></p>

<ul>
<li><p><strong>kCFRunLoopDefaultMode:</strong> Appçš„é»˜è®¤Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œ</p></li>
<li><p><strong>UITrackingRunLoopMode:</strong> ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“</p></li>
<li><p><strong>UIInitializationRunLoopMode:</strong> åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨</p></li>
<li><p><strong>GSEventReceiveRunLoopMode:</strong> æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°</p></li>
<li><p><strong>kCFRunLoopCommonModes:</strong> è¿™æ˜¯ä¸€ä¸ªå ä½ç”¨çš„Modeï¼Œä¸æ˜¯ä¸€ç§çœŸæ­£çš„Mode</p></li>
</ul>

<p>Cocoa å’Œ Core foundation å®šä¹‰äº†ä¸€ä¸ªé»˜è®¤çš„å’Œä¸€äº›å¸¸ç”¨çš„æ¨¡å¼,é€šå¸¸åœ¨ä»£ç ä¸­éƒ½æ˜¯ç”¨å­—ç¬¦ä¸²æ¥æ ‡è¯†è¿™äº›æ¨¡å¼ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç»™æ¨¡å¼åç§°æŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸²æ¥è‡ªå®šä¹‰æ¨¡å¼.<br/>
runloopä¸€å¯åŠ¨å°±ä¼šé€‰ä¸­ä¸€ç§æ¨¡å¼ï¼Œå½“é€‰ä¸­äº†ä¸€ç§æ¨¡å¼ä¹‹åå…¶å®ƒçš„æ¨¡å¼å°±éƒ½ä¸é¸Ÿã€‚ä¸€ä¸ªmodeé‡Œé¢å¯ä»¥æ·»åŠ å¤šä¸ªNSTimer(è§ä¸Šé¢å›¾ä¸€),ä¹Ÿå°±æ˜¯è¯´ä»¥åå½“åˆ›å»ºNSTimerçš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šå®ƒæ˜¯åœ¨ä»€ä¹ˆæ¨¡å¼ä¸‹è¿è¡Œçš„ã€‚</p>

<h3 id="toc_9">CFRunLoopSourceRef</h3>

<p><strong>CFRunLoopSourceRefæ˜¯äº‹ä»¶æºï¼ˆè¾“å…¥æºï¼‰</strong></p>

<p>è¾“å…¥æºå¼‚æ­¥çš„å‘é€æ¶ˆæ¯ç»™ä½ çš„çº¿ç¨‹ã€‚äº‹ä»¶æ¥æºå–å†³äºè¾“å…¥æºçš„ç§ç±»:åŸºäºç«¯å£çš„è¾“å…¥æºå’Œè‡ªå®šä¹‰è¾“å…¥æºã€‚åŸºäºç«¯å£çš„è¾“å…¥æºç›‘å¬ç¨‹åºç›¸åº”çš„ç«¯å£ã€‚è‡ªå®šä¹‰è¾“å…¥æºåˆ™ç›‘å¬è‡ªå®šä¹‰çš„äº‹ä»¶æºã€‚è‡³äº run loop,å®ƒä¸å…³å¿ƒè¾“å…¥æºçš„æ˜¯åŸºäºç«¯å£çš„è¾“å…¥æºè¿˜æ˜¯è‡ª å®šä¹‰çš„è¾“å…¥æºã€‚ç³»ç»Ÿä¼šå®ç°ä¸¤ç§è¾“å…¥æºä¾›ä½ ä½¿ç”¨ã€‚ä¸¤ç±»è¾“å…¥æºçš„åŒºåˆ«åœ¨äºå¦‚ä½•æ˜¾ç¤º: åŸºäºç«¯å£çš„è¾“å…¥æºç”±å†…æ ¸è‡ªåŠ¨å‘é€,è€Œè‡ªå®šä¹‰çš„åˆ™éœ€è¦äººå·¥ä»å…¶ä»–çº¿ç¨‹å‘é€ã€‚</p>

<p>å½“ä½ åˆ›å»ºè¾“å…¥æº,ä½ éœ€è¦å°†å…¶åˆ†é…ç»™ run loop ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ã€‚æ¨¡å¼åªä¼š åœ¨ç‰¹å®šäº‹ä»¶å½±å“ç›‘å¬çš„æºã€‚å¤§å¤šæ•°æƒ…å†µä¸‹,run loop è¿è¡Œåœ¨é»˜è®¤æ¨¡å¼ä¸‹,ä½†æ˜¯ä½ ä¹Ÿ å¯ä»¥ä½¿å…¶è¿è¡Œåœ¨è‡ªå®šä¹‰æ¨¡å¼ã€‚è‹¥æŸä¸€æºåœ¨å½“å‰æ¨¡å¼ä¸‹ä¸è¢«ç›‘å¬,é‚£ä¹ˆä»»ä½•å…¶ç”Ÿæˆçš„æ¶ˆ æ¯åªåœ¨ run loop è¿è¡Œåœ¨å…¶å…³è”çš„æ¨¡å¼ä¸‹æ‰ä¼šè¢«ä¼ é€’ã€‚</p>

<p>ä»¥å‰çš„åˆ†æ³•:<br/>
Port-Based Sources<br/>
Custom Input Sources<br/>
Cocoa Perform Selector Sources</p>

<p>ç°åœ¨çš„åˆ†æ³•:<br/>
Source0ï¼šéåŸºäºPortçš„<br/>
Source1ï¼šåŸºäºPortçš„</p>

<h3 id="toc_10">CFRunLoopTimerRef</h3>

<p><strong>CFRunLoopTimerRefæ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨</strong></p>

<h4 id="toc_11">NSTimer:</h4>

<pre><code class="language-text">- (void)timer2
{
    //NSTimer è°ƒç”¨äº†scheduledTimeræ–¹æ³•ï¼Œé‚£ä¹ˆä¼šè‡ªåŠ¨æ·»åŠ åˆ°å½“å‰çš„runloopé‡Œé¢å»ï¼Œè€Œä¸”runloopçš„è¿è¡Œæ¨¡å¼kCFRunLoopDefaultMode

    NSTimer *timer = [NSTimer scheduledTimerWithTimeInterval:2.0 target:self selector:@selector(run) userInfo:nil repeats:YES];

    //æ›´æ”¹æ¨¡å¼
    [[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];

}

- (void)timer1
{
    //    [NSTimer scheduledTimerWithTimeInterval:2.0 target:self selector:@selector(run) userInfo:nil repeats:YES];

    NSTimer *timer = [NSTimer timerWithTimeInterval:2.0 target:self selector:@selector(run) userInfo:nil repeats:YES];

    //å®šæ—¶å™¨æ·»åŠ åˆ°UITrackingRunLoopModeæ¨¡å¼ï¼Œä¸€æ—¦runloopåˆ‡æ¢æ¨¡å¼ï¼Œé‚£ä¹ˆå®šæ—¶å™¨å°±ä¸å·¥ä½œ
    //    [[NSRunLoop currentRunLoop] addTimer:timer forMode:UITrackingRunLoopMode];

    //å®šæ—¶å™¨æ·»åŠ åˆ°NSDefaultRunLoopModeæ¨¡å¼ï¼Œä¸€æ—¦runloopåˆ‡æ¢æ¨¡å¼ï¼Œé‚£ä¹ˆå®šæ—¶å™¨å°±ä¸å·¥ä½œ
    //    [[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];

    //å ä½æ¨¡å¼ï¼šcommon modesæ ‡è®°
    //è¢«æ ‡è®°ä¸ºcommon modesçš„æ¨¡å¼ kCFRunLoopDefaultMode  UITrackingRunLoopMode
    [[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];

    //    NSLog(@&quot;%@&quot;,[NSRunLoop currentRunLoop]);
}

- (void)run
{
    NSLog(@&quot;---run---%@&quot;,[NSRunLoop currentRunLoop].currentMode);
}

- (IBAction)btnClick {

    NSLog(@&quot;---btnClick---&quot;);
}
</code></pre>

<h4 id="toc_12">GCDä¸­çš„å®šæ—¶å™¨</h4>

<pre><code class="language-text">//0.åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);

    //1.åˆ›å»ºä¸€ä¸ªGCDçš„å®šæ—¶å™¨
    /*
     ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå®šæ—¶å™¨
     ç¬¬å››ä¸ªå‚æ•°ï¼šGCDçš„å›è°ƒä»»åŠ¡æ·»åŠ åˆ°é‚£ä¸ªé˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œå¦‚æœæ˜¯ä¸»é˜Ÿåˆ—åˆ™åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
     */
    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);

    //2.è®¾ç½®å®šæ—¶å™¨çš„å¼€å§‹æ—¶é—´ï¼Œé—´éš”æ—¶é—´ä»¥åŠç²¾å‡†åº¦

    //è®¾ç½®å¼€å§‹æ—¶é—´ï¼Œä¸‰ç§’é’Ÿä¹‹åè°ƒç”¨
    dispatch_time_t start = dispatch_time(DISPATCH_TIME_NOW,3.0 *NSEC_PER_SEC);
    //è®¾ç½®å®šæ—¶å™¨å·¥ä½œçš„é—´éš”æ—¶é—´
    uint64_t intevel = 1.0 * NSEC_PER_SEC;

    /*
     ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦ç»™å“ªä¸ªå®šæ—¶å™¨è®¾ç½®
     ç¬¬äºŒä¸ªå‚æ•°ï¼šå®šæ—¶å™¨çš„å¼€å§‹æ—¶é—´DISPATCH_TIME_NOWè¡¨ç¤ºä»å½“å‰å¼€å§‹
     ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šå®šæ—¶å™¨è°ƒç”¨æ–¹æ³•çš„é—´éš”æ—¶é—´
     ç¬¬å››ä¸ªå‚æ•°ï¼šå®šæ—¶å™¨çš„ç²¾å‡†åº¦ï¼Œå¦‚æœä¼ 0åˆ™è¡¨ç¤ºé‡‡ç”¨æœ€ç²¾å‡†çš„æ–¹å¼è®¡ç®—ï¼Œå¦‚æœä¼ å¤§äº0çš„æ•°å€¼ï¼Œåˆ™è¡¨ç¤ºè¯¥å®šæ—¶åˆ‡æ¢iå¯ä»¥æ¥æ”¶è¯¥å€¼èŒƒå›´å†…çš„è¯¯å·®ï¼Œé€šå¸¸ä¼ 0
     è¯¥å‚æ•°çš„æ„ä¹‰ï¼šå¯ä»¥é€‚å½“çš„æé«˜ç¨‹åºçš„æ€§èƒ½
     æ³¨æ„ç‚¹ï¼šGCDå®šæ—¶å™¨ä¸­çš„æ—¶é—´ä»¥çº³ç§’ä¸ºå•ä½ï¼ˆé¢è¯•ï¼‰
     */

    dispatch_source_set_timer(timer, start, intevel, 0 * NSEC_PER_SEC);

    //3.è®¾ç½®å®šæ—¶å™¨å¼€å¯åå›è°ƒçš„æ–¹æ³•
    /*
     ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦ç»™å“ªä¸ªå®šæ—¶å™¨è®¾ç½®
     ç¬¬äºŒä¸ªå‚æ•°ï¼šå›è°ƒblock
     */
    dispatch_source_set_event_handler(timer, ^{
        NSLog(@&quot;------%@&quot;,[NSThread currentThread]);
    });

    //4.æ‰§è¡Œå®šæ—¶å™¨
    dispatch_resume(timer);

    //æ³¨æ„ï¼šdispatch_source_tæœ¬è´¨ä¸Šæ˜¯OCç±»ï¼Œåœ¨è¿™é‡Œæ˜¯ä¸ªå±€éƒ¨å˜é‡ï¼Œéœ€è¦å¼ºå¼•ç”¨
    self.timer = timer;

GCDå®šæ—¶å™¨è¡¥å……
/*
 DISPATCH_SOURCE_TYPE_TIMER         å®šæ—¶å“åº”ï¼ˆå®šæ—¶å™¨äº‹ä»¶ï¼‰
 DISPATCH_SOURCE_TYPE_SIGNAL        æ¥æ”¶åˆ°UNIXä¿¡å·æ—¶å“åº”

 DISPATCH_SOURCE_TYPE_READ          IOæ“ä½œï¼Œå¦‚å¯¹æ–‡ä»¶çš„æ“ä½œã€socketæ“ä½œçš„è¯»å“åº”
 DISPATCH_SOURCE_TYPE_WRITE         IOæ“ä½œï¼Œå¦‚å¯¹æ–‡ä»¶çš„æ“ä½œã€socketæ“ä½œçš„å†™å“åº”
 DISPATCH_SOURCE_TYPE_VNODE         æ–‡ä»¶çŠ¶æ€ç›‘å¬ï¼Œæ–‡ä»¶è¢«åˆ é™¤ã€ç§»åŠ¨ã€é‡å‘½å
 DISPATCH_SOURCE_TYPE_PROC          è¿›ç¨‹ç›‘å¬,å¦‚è¿›ç¨‹çš„é€€å‡ºã€åˆ›å»ºä¸€ä¸ªæˆ–æ›´å¤šçš„å­çº¿ç¨‹ã€è¿›ç¨‹æ”¶åˆ°UNIXä¿¡å·

 ä¸‹é¢ä¸¤ä¸ªéƒ½å±äºMachç›¸å…³äº‹ä»¶å“åº”
    DISPATCH_SOURCE_TYPE_MACH_SEND
    DISPATCH_SOURCE_TYPE_MACH_RECV
 ä¸‹é¢ä¸¤ä¸ªéƒ½å±äºè‡ªå®šä¹‰çš„äº‹ä»¶ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯æœ‰è‡ªå·±æ¥è§¦å‘
    DISPATCH_SOURCE_TYPE_DATA_ADD
    DISPATCH_SOURCE_TYPE_DATA_OR
 */
</code></pre>

<h3 id="toc_13">CFRunLoopObserverRef</h3>

<p><strong>CFRunLoopObserverRefæ˜¯è§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜</strong></p>

<p>å¯ä»¥ç›‘å¬çš„æ—¶é—´ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ª</p>

<pre><code class="language-text">/* Run Loop Observer Activities */
typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry = (1UL &lt;&lt; 0),           // å³å°†è¿›å…¥ Loop
    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),    // å³å°†å¤„ç† Timer
    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),   // å³å°†å¤„ç† Source
    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),   // å³å°†è¿›å…¥ä¼‘çœ 
    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),    // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopExit = (1UL &lt;&lt; 7),            // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopAllActivities = 0x0FFFFFFFU   // æ‰€æœ‰çŠ¶æ€æ”¹å˜
};
</code></pre>

<p>å¦‚ä½•ç›‘å¬:</p>

<pre><code class="language-text"> //åˆ›å»ºä¸€ä¸ªrunloopç›‘å¬è€…
    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(CFAllocatorGetDefault(),kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) {

        NSLog(@&quot;ç›‘å¬runloopçŠ¶æ€æ”¹å˜---%zd&quot;,activity);
    });

    //ä¸ºrunloopæ·»åŠ ä¸€ä¸ªç›‘å¬è€…
    CFRunLoopAddObserver(CFRunLoopGetCurrent(), observer, kCFRunLoopDefaultMode);

    CFRelease(observer);
</code></pre>

<h2 id="toc_14">5. RunLoopå¤„ç†é€»è¾‘</h2>

<p><img src="media/14731740142157/14732109138343.jpg" alt=""/><br/>
<img src="media/14731740142157/14732110397325.jpg" alt=""/></p>

<p>ç½‘å‹æ•´ç†å¦‚ä¸‹:<br/>
<img src="media/14731740142157/14732111027007.jpg" alt=""/></p>

<h2 id="toc_15">6.RunLoopåº”ç”¨</h2>

<ul>
<li>NSTimer</li>
<li>ImageViewæ˜¾ç¤º  æ§åˆ¶æ–¹æ³•åœ¨ç‰¹å®šçš„æ¨¡å¼ä¸‹å¯ç”¨</li>
<li>PerformSelector</li>
<li>å¸¸é©»çº¿ç¨‹ åœ¨å­çº¿ç¨‹ä¸­å¼€å¯ä¸€ä¸ªrunloop</li>
<li>è‡ªåŠ¨é‡Šæ”¾æ± 
<ul>
<li>ç¬¬ä¸€æ¬¡åˆ›å»ºï¼šè¿›å…¥runloopçš„æ—¶å€™</li>
<li>æœ€åä¸€æ¬¡é‡Šæ”¾ï¼šrunloopé€€å‡ºçš„æ—¶å€™</li>
<li>å…¶å®ƒåˆ›å»ºå’Œé‡Šæ”¾ï¼šå½“runloopå³å°†ä¼‘çœ çš„æ—¶å€™ä¼šæŠŠä¹‹å‰çš„è‡ªåŠ¨é‡Šæ”¾æ± é‡Šæ”¾ï¼Œç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„é‡Šæ”¾æ± </li>
</ul></li>
</ul>

<h3 id="toc_16">å¸¸è§é—®é¢˜</h3>

<blockquote>
<p>è‡ªåŠ¨é‡Šæ”¾æ± ä»€ä¹ˆæ—¶å€™é‡Šæ”¾?</p>
</blockquote>

<p>é€šè¿‡Obserberç›‘å¬åœ¨runloopçš„çŠ¶æ€,ä¸€æ—¦ç›‘å¬åˆ°runloopå³å°†è¿›è¡Œç¡çœ ç­‰å¾…çŠ¶æ€(kCFRunLoopBeforeWaiting),å°±é‡Šæ”¾</p>

<p><img src="media/14731740142157/15167055358673.jpg" alt=""/></p>

<blockquote>
<p>åœ¨å¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨runloop?</p>
</blockquote>

<ol>
<li>å¼€å¯ä¸€ä¸ªå¸¸é©»çº¿ç¨‹(è®©ä¸€ä¸ªå­çº¿ç¨‹ä¸è¿›å…¥æ¶ˆäº¡çŠ¶æ€,ç­‰å¾…ä»å…¶ä»–çº¿ç¨‹å‘æ¥çš„æ¶ˆæ¯,å¤„ç†å„ç§äº‹ä»¶)ä¸¾ä¾‹:1&gt;åœ¨å­çº¿ç¨‹ä¸­å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ 2&gt; åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œä¸€äº›åœºæ™¯ç›‘æ§</li>
<li>å¯ä»¥æ§åˆ¶å®šæ—¶å™¨åœ¨é‚£ç§æ¨¡å¼ä¸‹è¿è¡Œ</li>
<li>å¯ä»¥è®©æŸäº›äº‹ä»¶(è¡Œä¸º,ä»»åŠ¡)åœ¨ç‰¹å®šæ¨¡å¼ä¸‹æ‰§è¡Œ(performSelector)</li>
<li>å¯ä»¥æ·»åŠ observerç›‘å¬runloopçš„ä¸€äº›çŠ¶æ€,æ¯”å¦‚ç›‘å¬ç‚¹å‡»äº‹ä»¶çš„å¤„ç†(åœ¨æ‰€æœ‰ç‚¹å‡»äº‹ä»¶å¤„ç†ä¹‹å‰åšä¸€äº›äº‹æƒ…)<br/>
###å‚è€ƒèµ„æ–™:</li>
</ol>

<hr/>

<p>å®˜æ–¹æ–‡æ¡£ <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html">Threading Programming Guide</a><br/><br/>
CFRunLoopRef<a href="http://opensource.apple.com/source/CF/CF-1151.16/">æºä»£ç </a></p>

<h3 id="toc_17">æœ€åç»™å‡ºå‡ ä¸ªå­¦ä¹ é“¾æ¥</h3>

<p><a href="http://www.jianshu.com/p/20d3bb3e8df5">RunLoopæ·±åº¦æ¢ç©¶ï¼ˆä¸€ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/6582c47a13c8">RunLoopæ·±åº¦æ¢ç©¶ï¼ˆäºŒï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/240683510692">RunLoopæ·±åº¦æ¢ç©¶ï¼ˆä¸‰ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/f3ed25944aef">RunLoopæ·±åº¦æ¢ç©¶ï¼ˆå››ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/1c50d0b0fe1a">RunLoopæ·±åº¦æ¢ç©¶ï¼ˆäº”ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/dc7ce81eda23">æ·±å…¥ç†è§£RunLoopæ–‡ç« </a></p>

<p><a href="http://blog.ibireme.com/2015/05/18/runloop/">http://blog.ibireme.com/2015/05/18/runloop/</a></p>

<p><a href="http://www.jianshu.com/p/ccd379c6db98">è¯» Threading Programming Guide ç¬”è®°ï¼ˆä¸€ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/30782af3fe1a">è¯» Threading Programming Guide ç¬”è®°ï¼ˆäºŒï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/30782af3fe1a">è¯» Threading Programming Guide ç¬”è®°ï¼ˆä¸‰ï¼‰</a></p>

<p><a href="http://www.jianshu.com/p/ccd379c6db98">è¯» Threading Programming Guide ç¬”è®°ï¼ˆå››ï¼‰</a></p>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14727863232294.html">runtime(å†…éƒ¨åˆ†äº«è‰ç¨¿)</a></h1>
			<p class="meta"><time datetime="2016-09-02T11:18:43+08:00" 
			pubdate data-updated="true">2016/9/2</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<blockquote>
<p>æœ¬æ–‡æ¶‰åŠåˆ°çš„Demoåœ°å€ <a href="https://github.com/Mekor/runtimeDemo">https://github.com/Mekor/runtimeDemo</a></p>
</blockquote>

<h2 id="toc_0">ç†è§£self,super,class,superclass</h2>

<p>åˆ›å»ºä¸€ä¸ªPersoné‡Œé¢æœ‰ä¸€ä¸ªç±»æ–¹æ³•:</p>

<pre><code class="language-objectivec">#import &quot;Person.h&quot;

@implementation Person
+(void)study {
    NSLog(@&quot;%@ %@ %@ %@&quot;,[self class],[self superclass],[super class],[super superclass]);
}
@end
</code></pre>

<p>Studentç»§æ‰¿è‡ªPerson,é‡å†™çˆ¶ç±»æ–¹æ³•</p>

<pre><code class="language-objectivec">#import &quot;Student.h&quot;

@implementation Student
+(void)study {
    NSLog(@&quot;%@ %@ %@ %@&quot;,[self class],[self superclass],[super class],[super superclass]);
}
@end
</code></pre>

<!--more-->

<p>è¿™ä¸¤ä¸ªè¾“å‡ºçš„éƒ½æ˜¯ä»€ä¹ˆ?<br/>
<img src="media/14727863232294/14729913552743.jpg" alt=""/></p>

<p>è¿™æ—¶,æˆ‘ä»¬åœ¨Studentä¸­ç”¨è¿™æ ·å†™:</p>

<pre><code class="language-objectivec">#import &quot;Student.h&quot;

@implementation Student
+(void)study {
//    NSLog(@&quot;%@ %@ %@ %@&quot;,[self class],[self superclass],[super class],[super superclass]);
    
    [super study];
}
@end
</code></pre>

<p>æ‰“æ–­ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°:<br/>
<img src="media/14727863232294/14729934417192.jpg" alt=""/></p>

<p>å¯ä»¥çœ‹å‡º:</p>

<pre><code class="language-objectivec">superï¼šæ˜¯ç¼–è¯‘å™¨æŒ‡ç¤ºç¬¦ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªæ ‡å¿—,å¹¶ä¸æ˜¯æŒ‡é’ˆï¼Œä»…ä»…æ˜¯æ ‡å¿—çš„å½“å‰å¯¹è±¡å»è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œæœ¬è´¨è¿˜æ˜¯å½“å‰å¯¹è±¡è°ƒç”¨
super:å¹¶ä¸æ˜¯è®©çˆ¶ç±»å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œè°ƒç”¨è€…è¿˜æ˜¯æœ¬èº«
classï¼šè·å–æ–¹æ³•è°ƒç”¨è€…çš„ç±»
superclass:è·å–æ–¹æ³•è°ƒç”¨è€…çš„çˆ¶ç±»
</code></pre>

<p>æ¶ˆæ¯æœºåˆ¶:(æ¥è‡ª:<a href="https://developer.apple.com/library/prerelease/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtHowMessagingWorks.html">å®˜æ–¹æ–‡æ¡£</a>)<br/>
<img src="media/14727863232294/messaging1.gif" alt="æ¶ˆæ¯æ¡†æ¶"/></p>

<p>å½“å¯¹è±¡æ”¶åˆ°æ¶ˆæ¯æ—¶,æ¶ˆæ¯å‡½æ•°é¦–å…ˆæ ¹æ®è¯¥å¯¹è±¡çš„ isa æŒ‡é’ˆæ‰¾åˆ°è¯¥å¯¹è±¡æ‰€å¯¹åº”çš„ç±»çš„æ–¹æ³•è¡¨,å¹¶ä»è¡¨ä¸­å¯»æ‰¾ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–¹æ³•é€‰æ ‡ã€‚å¦‚æœæ‰¾ä¸åˆ°,objc_msgSend å°†ç»§ç»­ä»çˆ¶ç±»ä¸­å¯»æ‰¾,ç›´åˆ° NSObject ç±»ã€‚ä¸€æ—¦æ‰¾åˆ°äº†æ–¹æ³•é€‰æ ‡, objc_msgSend åˆ™ä»¥æ¶ˆæ¯æ¥æ”¶è€…å¯¹è±¡ä¸ºå‚æ•°è°ƒç”¨,è°ƒç”¨è¯¥é€‰æ ‡å¯¹åº”çš„æ–¹æ³•å®ç°ã€‚</p>

<h2 id="toc_1">selfæ˜¯ä»å“ªé‡Œæ¥çš„?</h2>

<blockquote>
<p>å®˜æ–¹è§£é‡Š:<a href="https://developer.apple.com/library/prerelease/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtHowMessagingWorks.html">Objective-C Runtime Programming Guide</a><img src="media/14727863232294/14729941396965.jpg" alt=""/></p>
</blockquote>

<p>ç®€å•è¯´æ¯ä¸ªæ–¹æ³•éƒ½å­˜åœ¨å¹¶ä¸”éšè—çš„ä¸¤ä¸ªå‚æ•°(self,_cmd),éšä¾¿å†™ä¸ªæ–¹æ³•çœ‹ä¸‹:<br/>
Studentä¸­å†™ä¸ªtextæ–¹æ³•,ç„¶åæ‰“å°ä¸‹è¿™ä¸¤ä¸ªéšè—å‚æ•°.<br/>
<img src="media/14727863232294/14729960900273.jpg" alt=""/><br/>
<img src="media/14727863232294/14729961142923.jpg" alt=""/></p>

<h2 id="toc_2">åŠ¨æ€æ·»åŠ æ–¹æ³•</h2>

<p>ä¸Šé¢è¯´äº†ä¸€äº›è²Œä¼¼å’Œruntimeæ²¡æœ‰ä»€ä¹ˆå…³ç³»,runtimeåŸºç¡€çŸ¥è¯†ç±»ä¼¼ç±»çš„æ„æˆ,å¯¹è±¡çš„æ„æˆè¿™é‡Œä¸å†ä»‹ç»,å¯ä»¥è‡ªå·±å»çœ‹å®šä¹‰.å½“ç„¶ä¹Ÿå¯ä»¥å»<a href="http://opensource.apple.com/source/objc4/objc4-680/runtime/">è‹¹æœçš„å¼€æºç½‘ç«™</a>æŸ¥çœ‹,å¦‚æœç½‘ç«™ä¸æ–¹ä¾¿å¯ä»¥å»è‹¹æœçš„<a href="https://github.com/opensource-apple/objc4">github</a>ä¸‹è½½å¼€æºä»£ç ç ”ç©¶...  ...ç»§ç»­...é‚£ä¹ˆæ ¹æ®ä¸Šé¢æ‰€è¯´çš„æ–¹æ³•è¯´ä¸‹åŠ¨æ€æ·»åŠ æ–¹æ³•.</p>

<blockquote>
<p>æ€è€ƒä¸€ä¸‹,å’±ä»¬newé¡¹ç›®ä¸­å°†é‡‡ç”¨è·¯ç”±æ¨¡å¼è¿›è¡Œé¡µé¢è·³è½¬,ä»ç½‘é¡µè·³è½¬è¿›å…¥appè°ƒç”¨ä¸€ä¸ªæ–¹æ³•,ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ç§»åŠ¨ç«¯å’Œåå°åè®®å¥½çš„å†…å®¹,è¿™æ ·è·³è½¬ä¸ä¼šå‡ºç°é—®é¢˜.ä½†æ˜¯å¦‚æœåå°å†™é”™äº†æˆ–è€…ä¼ è¾“ä¸­å‡ºç°é—®é¢˜å¯¼è‡´urlä¸­åŒ…å«çš„æ–¹æ³•åä¸æ˜¯è§„å®šçš„æ–¹æ³•å.è¿™æ—¶æ€ä¹ˆåŠ?</p>
</blockquote>

<pre><code class="language-objectivec">    Student *s = [Student new];
    
    // 1. æ¯”å¦‚æˆ‘ä»¬è¦è°ƒç”¨ Studentä¸­çš„eatæ–¹æ³•, é»˜è®¤è¿™æ ·å†™[s eat]; ä½†æ˜¯ä¸è¡Œ,å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å®šä¹‰.
//    [s eat];
    // 2. ä¹Ÿå¯ä»¥è¿™æ ·è°ƒç”¨[s performSelector:@selector(eat)];è¿™æ ·æ²¡æœ‰é—®é¢˜,@selectorä¸­å‚æ•°æ˜¯å­—ç¬¦ä¸²,è¿™ä¸ªå‚è€ƒswift
//    [s performSelector:@selector(eat)];
    // 3. ä½¿ç”¨stringåˆ›å»ºSEL
    
#pragma clang diagnostic push
#pragma clang diagnostic ignored&quot;-Warc-performSelector-leaks&quot;
    [s performSelector:NSSelectorFromString(@&quot;eat&quot;)];
#pragma clang diagnostic pop
    
    // ä¸Šé¢è¿™æ ·è°ƒç”¨ä¼šæŠ¥é”™,æˆ‘ä»¬åœ¨å¯¹è±¡è°ƒç”¨æœªå®ç°æ–¹æ³•çš„æ—¶å€™åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªæ–¹æ³•,é¿å…æŠ›å‡ºå¼‚å¸¸.
</code></pre>

<p>æ€ä¹ˆå¿½ç•¥ç¼–è¯‘å™¨è­¦å‘Šå·²ç»åˆ†äº«è¿‡,å¯ä»¥å‚è€ƒ:<a href="http://www.citynight.cn/Blog/14676105703423.html">http://www.citynight.cn/Blog/14676105703423.html</a></p>

<h3 id="toc_3">æ€ä¹ˆåŠ¨æ€æ·»åŠ æ–¹æ³•å‘¢?</h3>

<p><img src="media/14727863232294/14729983827897.jpg" alt=""/><br/>
ä¸Šé¢æ˜¯åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•çš„ä¾‹å­,åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„<code>+(BOOL)resolveClassMethod:(SEL)sel</code><br/>
<strong>æ³¨æ„:</strong>ä¸Šé¢å‡½æ•°ç±»å‹,æœ‰äººå¯èƒ½å¥½å¥‡è¿™å—ä¸ºä»€ä¹ˆå†™æˆ&quot;v@:&quot;  ?å‚è§:å‡½æ•°ç±»å‹, æ›´å¤šå…³äºè½¬å‘æœºåˆ¶å‚è§:<a href="http://www.citynight.cn/Blog/14733118707964.html">è½¬å‘æœºåˆ¶</a></p>

<h3 id="toc_4">å…³äºå‡½æ•°ç±»å‹</h3>

<p>å…ˆçœ‹æ–‡æ¡£:<br/>
<img src="media/14727863232294/14730056768742.jpg" alt=""/><br/>
æŸ¥çœ‹<code>Objective-C type encodings</code> <img src="media/14727863232294/14730058881001.jpg" alt=""/><br/>
æ‰€ä»¥ä¸Šé¢void eat(...)åº”è¯¥è¡¨è¿°æˆ <code>&quot;v@:&quot;</code></p>

<p><strong>è¡¥å……:</strong> åŠ¨æ€è°ƒç”¨æ–¹æ³•ç³»ç»Ÿé»˜è®¤æä¾›ä¸€åˆ°ä¸¤ä¸ªå‚æ•°çš„æ–¹æ³•è°ƒç”¨, <del>è¿™é‡Œå°è£…äº†ä¸€ä¸ªæ— é™å‚æ•°çš„æ–¹æ³•è°ƒç”¨.<a href="https://github.com/Mekor/NSObject-SEL">NSObject-SEL****</a></del>  æˆ‘æŠŠä¸€äº›æ‰©å±•è¿›è¡Œäº†æ€»ç»“,è¿˜ä¸å®Œå–„,åœ°å€<a href="https://github.com/Mekor/MKExtension">MKExtension</a></p>

<h3 id="toc_5">å…³äºIMP(å‡½æ•°æŒ‡é’ˆ)</h3>

<pre><code class="language-objectivec">/// A pointer to the function of a method implementation. 
#if !OBJC_OLD_DISPATCH_PROTOTYPES
typedef void (*IMP)(void /* id, SEL, ... */ ); 
#else
typedef id (*IMP)(id, SEL, ...); 
#endif
</code></pre>

<p>å½“å‰ç‰ˆæœ¬Xcodeå¦‚æœä½¿ç”¨IMPçš„è¯,é»˜è®¤æ˜¯é€‰æ‹©ç¬¬ä¸€ä¸ªä¹Ÿå°±æ˜¯æ— å‚æ— è¿”å›å€¼.å¦‚æœéœ€è¦å‚æ•°æœ‰è¿”å›å€¼çš„è¯,éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶.å¦‚ä¸‹:</p>

<h2 id="toc_6">æ–¹æ³•äº¤æ¢(Method Swizzling:ä¼ è¯´ä¸­çš„é»‘é­”æ³•)</h2>

<p>ä¸€èˆ¬ä½¿ç”¨æ–¹æ³•äº¤æ¢éƒ½æ˜¯æƒ³ç»™ç³»ç»Ÿæä¾›çš„æ–¹æ³•æ·»åŠ ä¸€äº›å…¶ä»–çš„åŠŸèƒ½çš„æ—¶å€™ä½¿ç”¨.newä¸­ä½¿ç”¨æ–¹æ³•äº¤æ¢çš„ä¾‹å­:</p>

<pre><code class="language-objectivec">#import &quot;UIActionSheet+Front.h&quot;

#import &lt;objc/runtime.h&gt;

@implementation UIActionSheet (Front)
- (void)customShowInView:(UIView *)view{
    for(UIWindow * tmpWin in [[UIApplication sharedApplication] windows]){
        [tmpWin endEditing:NO];
    }
    [self customShowInView:view];
}
+ (void)load{
    swizzleAllActionSheet();
}
@end

void swizzleAllActionSheet(){
    Class c = [UIActionSheet class];
    SEL origSEL = @selector(showInView:);
    SEL newSEL = @selector(customShowInView:);
    Method origMethod = class_getInstanceMethod(c, origSEL);
    Method newMethod = class_getInstanceMethod(c, newSEL);
    method_exchangeImplementations(origMethod, newMethod);
}
</code></pre>

<p>å…³äºæ–¹æ³•äº¤æ¢,åœ¨newé¡¹ç›®ä¸­å·²ç»å°è£…å¥½äº†,ä»£ç å¦‚ä¸‹:</p>

<pre><code class="language-objectivec">// ObjcRuntime.hæ–‡ä»¶
void Swizzle(Class c, SEL origSEL, SEL newSEL);

//ObjcRuntime.mæ–‡ä»¶
//é™æ€å°±äº¤æ¢é™æ€ï¼Œå®ä¾‹æ–¹æ³•å°±äº¤æ¢å®ä¾‹æ–¹æ³•
void Swizzle(Class c, SEL origSEL, SEL newSEL)
{
    Method origMethod = class_getInstanceMethod(c, origSEL);
    Method newMethod = nil;
    if (!origMethod) {
        origMethod = class_getClassMethod(c, origSEL);
        if (!origMethod) {
            return;
        }
        newMethod = class_getClassMethod(c, newSEL);
        if (!newMethod) {
            return;
        }
    }else{
        newMethod = class_getInstanceMethod(c, newSEL);
        if (!newMethod) {
            return;
        }
    }
    
    //è‡ªèº«å·²ç»æœ‰äº†å°±æ·»åŠ ä¸æˆåŠŸï¼Œç›´æ¥äº¤æ¢å³å¯
    if(class_addMethod(c, origSEL, method_getImplementation(newMethod), method_getTypeEncoding(newMethod))){
        class_replaceMethod(c, newSEL, method_getImplementation(origMethod), method_getTypeEncoding(origMethod));
    }else{
        method_exchangeImplementations(origMethod, newMethod);
    }
}
</code></pre>

<p>ç”¨æ³•(è¿˜æ˜¯ä»¥Studentä¸ºä¾‹):<br/>
Studentä¸­æ·»åŠ ä¸¤ä¸ªå¯¹è±¡æ–¹æ³•,ä¸€ä¸ªrun,ä¸€ä¸ªsleep.æˆ‘ä»¬çš„ç›®çš„æ˜¯äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</p>

<pre><code class="language-objectivec">-(void)run {
    NSLog(@&quot;è·‘ğŸƒ&quot;);
}
-(void)sleep {
    NSLog(@&quot;ç¡è§‰ğŸ˜´&quot;);
}
+(void)load {
    Swizzle(self, @selector(run), @selector(sleep));
}
</code></pre>

<p>æ§åˆ¶å™¨è°ƒç”¨çš„ç»“æœ:<br/>
<img src="media/14727863232294/14730042652865.jpg" alt=""/></p>

<h2 id="toc_7">æ·»åŠ å±æ€§</h2>

<p>åŠ¨æ€æ·»åŠ å±æ€§ç”¨çš„æœ€å¤šçš„åœ°æ–¹åº”è¯¥æ˜¯ç»™åˆ†ç±»æ·»åŠ å±æ€§.  <del>æˆ‘åœ¨é¡¹ç›®ä¸­æ·»åŠ è¿‡ä¸€ä¸ªåˆ†ç±»<code>UIView+Tap</code>è¿™ä¸ªä¹Ÿå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹<a href="https://github.com/Mekor/UIView-Tap">UIView-Tap</a></del>  æˆ‘æŠŠä¸€äº›æ‰©å±•è¿›è¡Œäº†æ€»ç»“,è¿˜ä¸å®Œå–„,åœ°å€<a href="https://github.com/Mekor/MKExtension">MKExtension</a></p>

<pre><code class="language-objectivec">#import &quot;UIView+Tap.h&quot;
#import &lt;objc/runtime.h&gt;

static const void* tagValue = &amp;tagValue;

@interface UIView ()
@property (nonatomic, copy) void(^tapAction)(id);
@end

@implementation UIView (Tap)
- (void)tap{
    if (self.tapAction) {
        self.tapAction(self);
    }
}
- (void)addTapBlock:(void(^)(id obj))tapAction{
    self.tapAction = tapAction;
    if (![self gestureRecognizers]) {
        self.userInteractionEnabled = YES;
        UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(tap)];
        [self addGestureRecognizer:tap];
    }
}

-(void)setTapAction:(void (^)(id))tapAction {
    objc_setAssociatedObject(self, tagValue, tapAction, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
-(void (^)(id))tapAction {
    return objc_getAssociatedObject(self, tagValue);
}
@end
</code></pre>

<p>ä¸»è¦æ˜¯set&amp;getæ–¹æ³•,è¿™ç‚¹æ³¨æ„äº†ä¹Ÿå°±æ²¡å•¥äº†..</p>

<h2 id="toc_8">å…¶ä»–</h2>

<ol>
<li>ç³»ç»Ÿä¸­å¸¸è§çš„ä½¿ç”¨åˆ°runtimeçš„åœ°æ–¹:
<a href="http://www.citynight.cn/Blog/14726525723684.html">KVOå†…éƒ¨å®ç°åŸç†</a></li>
<li>æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨åˆ°runtimeçš„åœ°æ–¹:</li>
<li>å­—å…¸è½¬æ¨¡å‹: å¯ä»¥å‚çœ‹<code>MJExtension</code> å®ƒçš„æ ¸å¿ƒä»£ç åœ¨:<code>NSObject+MJProperty.m</code>ç¬¬150è¡Œå¼€å§‹</li>
</ol>

<pre><code class="language-objectivec">#pragma mark - å…¬å…±æ–¹æ³•
+ (NSMutableArray *)properties
{
    NSMutableArray *cachedProperties = [self dictForKey:&amp;MJCachedPropertiesKey][NSStringFromClass(self)];
    
    if (cachedProperties == nil) {
        cachedProperties = [NSMutableArray array];
        
        [self mj_enumerateClasses:^(__unsafe_unretained Class c, BOOL *stop) {
            // 1.è·å¾—æ‰€æœ‰çš„æˆå‘˜å˜é‡
            unsigned int outCount = 0;
            objc_property_t *properties = class_copyPropertyList(c, &amp;outCount);
            
            // 2.éå†æ¯ä¸€ä¸ªæˆå‘˜å˜é‡
            for (unsigned int i = 0; i&lt;outCount; i++) {
                MJProperty *property = [MJProperty cachedPropertyWithProperty:properties[i]];
                // è¿‡æ»¤æ‰Foundationæ¡†æ¶ç±»é‡Œé¢çš„å±æ€§
                if ([MJFoundation isClassFromFoundation:property.srcClass]) continue;
                property.srcClass = c;
                [property setOriginKey:[self propertyKey:property.name] forClass:self];
                [property setObjectClassInArray:[self propertyObjectClassInArray:property.name] forClass:self];
                [cachedProperties addObject:property];
            }
            
            // 3.é‡Šæ”¾å†…å­˜
            free(properties);
        }];
        
        [self dictForKey:&amp;MJCachedPropertiesKey][NSStringFromClass(self)] = cachedProperties;
    }
    
    return cachedProperties;
}
</code></pre>

<p>è‡ªå®šä¹‰å­—å…¸è½¬æ¨¡å‹ä¸­logçš„è¾“å‡ºå¯ä»¥å‚è§Xcodeæ’ä»¶<code>ESJsonFormat</code>ä¸­<code>ESJsonFormatManager.m</code>ç¬¬47è¡Œ:</p>

<pre><code class="language-objectivec">/**
 *  æ ¼å¼åŒ–OCå±æ€§å­—ç¬¦ä¸²
 *
 *  @param key       JSONé‡Œé¢keyå­—æ®µ
 *  @param value     JSONé‡Œé¢keyå¯¹åº”çš„NSDictionæˆ–è€…NSArray
 *  @param classInfo ç±»ä¿¡æ¯
 *
 *  @return
 */
+ (NSString *)formatObjcWithKey:(NSString *)key value:(NSObject *)value classInfo:(ESClassInfo *)classInfo{
    NSString *qualifierStr = @&quot;copy&quot;;
    NSString *typeStr = @&quot;NSString&quot;;
    //åˆ¤æ–­å¤§å°å†™
    if ([ESUppercaseKeyWords containsObject:key] &amp;&amp; [ESJsonFormatSetting defaultSetting].uppercaseKeyWordForId) {
        key = [key uppercaseString];
    }
    if ([value isKindOfClass:[NSString class]]) {
        return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ *%@;&quot;,qualifierStr,typeStr,key];
    }else if([value isKindOfClass:[@(YES) class]]){
        //the &#39;NSCFBoolean&#39; is private subclass of &#39;NSNumber&#39;
        qualifierStr = @&quot;assign&quot;;
        typeStr = @&quot;BOOL&quot;;
        return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ %@;&quot;,qualifierStr,typeStr,key];
    }else if([value isKindOfClass:[NSNumber class]]){
        qualifierStr = @&quot;assign&quot;;
        NSString *valueStr = [NSString stringWithFormat:@&quot;%@&quot;,value];
        if ([valueStr rangeOfString:@&quot;.&quot;].location!=NSNotFound){
            typeStr = @&quot;CGFloat&quot;;
        }else{
            NSNumber *valueNumber = (NSNumber *)value;
            if ([valueNumber longValue]&lt;2147483648) {
                typeStr = @&quot;NSInteger&quot;;
            }else{
                typeStr = @&quot;long long&quot;;
            }
        }
        return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ %@;&quot;,qualifierStr,typeStr,key];
    }else if([value isKindOfClass:[NSArray class]]){
        NSArray *array = (NSArray *)value;
        
        //May be &#39;NSString&#39;ï¼Œwill crash
        NSString *genericTypeStr = @&quot;&quot;;
        NSObject *firstObj = [array firstObject];
        if ([firstObj isKindOfClass:[NSDictionary class]]) {
            ESClassInfo *childInfo = classInfo.propertyArrayDic[key];
            genericTypeStr = [NSString stringWithFormat:@&quot;&lt;%@ *&gt;&quot;,childInfo.className];
        }else if ([firstObj isKindOfClass:[NSString class]]){
            genericTypeStr = @&quot;&lt;NSString *&gt;&quot;;
        }else if ([firstObj isKindOfClass:[NSNumber class]]){
            genericTypeStr = @&quot;&lt;NSNumber *&gt;&quot;;
        }
        
        qualifierStr = @&quot;strong&quot;;
        typeStr = @&quot;NSArray&quot;;
        if ([ESJsonFormatSetting defaultSetting].useGeneric &amp;&amp; [ESUtils isXcode7AndLater]) {
            return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@%@ *%@;&quot;,qualifierStr,typeStr,genericTypeStr,key];
        }
        return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ *%@;&quot;,qualifierStr,typeStr,key];
    }else if ([value isKindOfClass:[NSDictionary class]]){
        qualifierStr = @&quot;strong&quot;;
        ESClassInfo *childInfo = classInfo.propertyClassDic[key];
        typeStr = childInfo.className;
        if (!typeStr) {
            typeStr = [key capitalizedString];
        }
        return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ *%@;&quot;,qualifierStr,typeStr,key];
    }
    return [NSString stringWithFormat:@&quot;@property (nonatomic, %@) %@ *%@;&quot;,qualifierStr,typeStr,key];
}

</code></pre>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="åŸç†æ¢ç©¶_1.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6.html"><strong>åŸç†æ¢ç©¶&nbsp;(7)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E6%8A%80%E5%B7%A7.html"><strong>æŠ€å·§&nbsp;(32)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E6%95%99%E7%A8%8B.html"><strong>æ•™ç¨‹&nbsp;(20)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E9%81%87%E5%88%B0Bug.html"><strong>é‡åˆ°Bug&nbsp;(12)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E6%9D%82%E8%AE%B0.html"><strong>æ‚è®°&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift&nbsp;(23)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="C/C++.html"><strong>C/C++&nbsp;(4)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Linux.html"><strong>Linux&nbsp;(3)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Documentation.html"><strong>Documentation&nbsp;(8)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Java.html"><strong>Java&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="LeetCode.html"><strong>LeetCode&nbsp;(1)</strong></a>
	        
	        
	        
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15962945237035.html">632. Smallest Range Covering Elements from K Lists</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15654059537017.html"># æ·±å…¥ç†è§£ iOS äº‹ä»¶æœºåˆ¶</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15653483390225.html">å›¾åƒæ˜¾ç¤ºåŸç†</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15653376209289.html">äº‹ä»¶ä¼ é€’</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15653325472073.html">æµ·åº•æç‚¹é¤Pad ä¼˜åŒ–</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>



  














<style type="text/css">
  
/* PrismJS 1.14.0
https://prismjs.com/download.html#themes=prism-solarizedlight&languages=markup+css+clike+javascript */
/*
 Solarized Color Schemes originally by Ethan Schoonover
 http://ethanschoonover.com/solarized

 Ported for PrismJS by Hector Matos
 Website: https://krakendev.io
 Twitter Handle: https://twitter.com/allonsykraken)
*/

/*
SOLARIZED HEX
--------- -------
base03    #002b36
base02    #073642
base01    #586e75
base00    #657b83
base0     #839496
base1     #93a1a1
base2     #eee8d5
base3     #fdf6e3
yellow    #b58900
orange    #cb4b16
red       #dc322f
magenta   #d33682
violet    #6c71c4
blue      #268bd2
cyan      #2aa198
green     #859900
*/

code[class*="language-"],
pre[class*="language-"] {
  color: #657b83; /* base00 */
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;

  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
  background: #073642; /* base02 */
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
  background: #073642; /* base02 */
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: .5em 0;
  overflow: auto;
  border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  background-color: #fdf6e3; /* base3 */
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #93a1a1; /* base1 */
}

.token.punctuation {
  color: #586e75; /* base01 */
}

.namespace {
  opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
  color: #268bd2; /* blue */
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.url,
.token.inserted {
  color: #2aa198; /* cyan */
}

.token.entity {
  color: #657b83; /* base00 */
  background: #eee8d5; /* base2 */
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #859900; /* green */
}

.token.function,
.token.class-name {
  color: #b58900; /* yellow */
}

.token.regex,
.token.important,
.token.variable {
  color: #cb4b16; /* orange */
}

.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>
  
    


</body>
</html>